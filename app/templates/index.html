<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}?ver=11">
    <title>Home</title>
</head>
<body>
  <div class="main-container">
    <h1>Welcome, {{ user_email }}</h1>

    <div class="movies">
      {% for movie in movies %}
      <div class="movie">
        <a href="/movie/{{ movie.name }}">
          <img src="{{ movie.poster }}" alt="Poster for {{ movie.name }}">
        </a>
        <div class="progress-container" data-movie="{{ movie.name }}" data-seconds="{{ movie.progress_seconds }}">
          <div class="progress-bar"></div>
        </div>
        <div class="movie-title">{{ movie.name }}</div>
      </div>
      {% endfor %}
    </div>

    <!-- EXISTING TMDb SEARCH (your current search and results) -->
    {% if searched_movies|length == 0 %}
    <div class="search-wrapper bottom-search">
      <div class="search-container">
        <form method="POST" action="/">
          <input type="text" name="query" placeholder="request a movie..." required>
          <button type="submit">Search</button>
        </form>
      </div>
    </div>
    {% else %}
    <div class="search-wrapper top-search">
      <div class="search-container">
        <form method="POST" action="/">
          <input type="text" name="query" placeholder="request a movie..." required>
          <button type="submit">Search</button>
        </form>
      </div>
      <div id="searched-movies" class="tmdb-results-container">
        {% for m in searched_movies %}
        <div class="tmdb-result" data-id="{{ m.id }}">
          <div class="cancel-wrapper">
            <button class="close-btn" title="Remove">Cancel Request</button>
          </div>

          {% if m.poster_path %}
          <img src="https://image.tmdb.org/t/p/w500{{ m.poster_path }}" alt="{{ m.title }}">
          {% else %}
          <div style="width:150px; height:225px; background:#ccc; display:flex; align-items:center; justify-content:center;">No Image</div>
          {% endif %}

          <div class="tmdb-details">
            <h3>{{ m.title }} ({{ m.release_date[:4] if m.release_date else 'N/A' }})</h3>
            <p>{{ m.overview }}</p>
          </div>
          <div class="download-controls">
            <button class="download-btn" data-id="{{ m.id }}" data-title="{{ m.title|e }}">Download</button>
            <div class="download-status" style="display:none;">
              <progress value="0" max="1"></progress>
              <span class="status-text">Loading...</span>
            </div>
          </div>
          <div class="download-status" style="display:none;">
              <progress value="0" max="1"></progress>
              <span class="status-text"></span>
          </div>
        </div>

        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <video id="dummy" style="display:none"></video>
  <script>
    const dummy = document.getElementById("dummy");
    const containers = document.querySelectorAll(".progress-container");

    containers.forEach(container => {
        const movie = container.dataset.movie;
        const seconds = parseFloat(container.dataset.seconds);
        const bar = container.querySelector(".progress-bar");

        const src = `/media/${movie}/movie.mp4`;
        dummy.src = src;

        dummy.addEventListener("loadedmetadata", () => {
            const duration = dummy.duration;
            if (duration > 0 && seconds > 0) {
                const percent = Math.min((seconds / duration) * 100, 100);
                bar.style.width = percent + "%";
            }
        }, { once: true });

        dummy.load();
    });
  </script>

  <script>
    document.querySelectorAll("#searched-movies .close-btn").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        const movieDiv = e.target.closest(".tmdb-result");
        const movieId = movieDiv.getAttribute("data-id");

        try {
          const response = await fetch(`/cancel_download/${movieId}`, { method: "POST" });
          if (response.ok) {
            movieDiv.remove();
          } else {
            alert("Failed to cancel");
          }
        } catch (err) {
          alert("Error cancelling movie");
        }
      });
    });
  </script>

  <script>
    document.querySelectorAll(".download-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const tmdbId = btn.getAttribute("data-id");
        const container = btn.closest(".tmdb-result");
        const statusDiv = container.querySelector(".download-status");
        const progressBar = statusDiv.querySelector("progress");
        const statusText = statusDiv.querySelector(".status-text");

        btn.disabled = true;
        statusDiv.style.display = "block";
        statusText.textContent = "Starting...";

        const res = await fetch(`/start_download/${tmdbId}`, { method: "POST" });
        const data = await res.json();
        if (!res.ok) {
          statusText.textContent = data.error || "Error";
          return;
        }

        const title = data.title;

        // Poll download progress
        const poll = setInterval(async () => {
          const res2 = await fetch(`/download_status/${encodeURIComponent(title)}`);
          const d = await res2.json();
          if (!res2.ok) {
            statusText.textContent = d.error || "Download not found";
            clearInterval(poll);
            return;
          }

          progressBar.value = d.progress;
          statusText.textContent = (d.progress * 100).toFixed(1) + "% - " + d.state;

          if (d.progress >= 1.0) {
            clearInterval(poll);
            statusText.textContent = "Download Complete, refresh to watch.";
          }
        }, 3000);
      });
    });
  </script>


  <script>
  document.querySelectorAll(".tmdb-result").forEach(async (div) => {
    const tmdbId = div.dataset.id;
    const downloadBtn = div.querySelector(".download-btn");
    const statusDiv = div.querySelector(".download-status");
    const progressBar = statusDiv.querySelector("progress");
    const statusText = statusDiv.querySelector(".status-text");
    const res = await fetch(`/download_state/${tmdbId}`);
    const data = await res.json();

    downloadBtn.style.display = 'none';
    statusDiv.style.display = 'block';


    if (data.state === "completed") {
      div.remove(); // already downloaded, no need to show
    } else if (data.state === "downloading") {
      downloadBtn.disabled = true;
      statusDiv.style.display = "block";
      statusText.textContent = "Loading...";

      const poll = setInterval(async () => {
        const res2 = await fetch(`/download_status/${encodeURIComponent(downloadBtn.dataset.title)}`);
        const d = await res2.json();
        if (!res2.ok) {
          statusText.textContent = d.error || "Download not found";
          clearInterval(poll);
          return;
        }

        progressBar.value = d.progress;
        statusText.textContent = (d.progress * 100).toFixed(1) + "% - " + d.state;

        if (d.progress >= 1.0) {
          clearInterval(poll);
          div.remove(); // auto-remove when complete
        }
      }, 3000);
    }
  });
  </script>



</body>
</html>
